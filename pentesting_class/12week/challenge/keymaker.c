#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/ioctl.h>
#include <net/if.h>
#include <arpa/inet.h>

#define INTERFACE "eth0" 
//Change to the correct network interface (e.g., wlan0 for Wi-Fi)

 void get_mac_address(unsigned char *mac) {
     struct ifreq ifr;
     int sock = socket(AF_INET, SOCK_DGRAM, 0);

     if (sock < 0) {
         perror("Socket error");
         exit(EXIT_FAILURE);
     }

     strncpy(ifr.ifr_name, INTERFACE, IFNAMSIZ - 1);
     if (ioctl(sock, SIOCGIFHWADDR, &ifr) < 0) {
         perror("IOCTL error");
         close(sock);
         exit(EXIT_FAILURE);
     }

     close(sock);
     memcpy(mac, ifr.ifr_hwaddr.sa_data, 6);
 }

 int is_authorized() {
     unsigned char mac[6];
     unsigned char allowed_mac[6] = {0x88, 0x00, 0x27, 0xd2, 0x26, 0x79};  // Replace with your target MAC

     get_mac_address(mac);

     //printf("Current MAC: %02x:%02x:%02x:%02x:%02x:%02x\n",
      //      mac[0], mac[1], mac[2], mac[3], mac[4], mac[5]);

     if (memcmp(mac, allowed_mac, 6) == 0) {
         printf("Authorized: Code is running!\n");
         return 1;
     } else {
         printf("Unauthorized: Access denied.\n Not the original computer\n");
         return 0;
     }
 }
char * encrypt(char* key2,char* awn){
    char hold;
    char holder[3];
    for(int i= 0; i < strlen(key2); i++){
        hold = key2[i] ^ (i+65);
        sprintf(holder, "%02X", hold);
        strcat(awn,holder);
    }
    return awn;
}

int main(int argc , char** argv) {
    if (is_authorized()) {
        // Proceed with the rest of the program
        printf("Executing secure code...\n");
	if (argc < 3){
		printf("please insert building and room number for key\n");
		exit(EXIT_FAILURE);
	}
	char key[strlen(argv[1])+1];
    strcpy(key,argv[1]);
    	
	int holder;
	int j =0;
	for(int i= 0; i < strlen(argv[1]); i= i+2){
        if (j == strlen(argv[2])){
            break;
        }
		key[i] = argv[2][j];
		j++;
    }

	char here[strlen(key)*2+1];
	strcpy(here,"");
    encrypt(key,here);
	char final[strlen(argv[1])+strlen(here)+3];
	sprintf(final,"%s{%s}",argv[1],here);
    printf("Key saved\n",final);

     } else {
//        Exit or restrict access
        exit(EXIT_FAILURE);
    }
    return 0;
}

